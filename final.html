<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Course Management Dashboard</title>
    <style>
        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #000000 50%, #1a1a2e 100%);
            color: white; min-height: 100vh;
        }

        /* Login Page Styles */
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #000000 50%, #1a1a2e 100%);
            color: white;
            flex-direction: column;
            padding: 20px;
        }
        .login-card {
            background: rgba(31, 41, 55, 0.7); /* Slightly more transparent */
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        .login-card h2 {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            color: #dc2626; /* Red accent for title */
        }
        .login-card .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }
        .login-card .form-label {
            display: block;
            margin-bottom: 0.5rem;
        }
        .login-card .form-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #4b5563;
            background: #374151;
            color: white;
        }
        .login-card .btn-primary {
            width: 100%;
            margin-top: 1.5rem;
            padding: 1rem;
            font-size: 1rem;
        }
        .login-message {
            margin-top: 1rem;
            color: #ef4444; /* Error red */
            font-weight: 500;
        }

        /* Dashboard content initially hidden */
        #dashboard-content {
            display: none; /* Initially hide the entire dashboard */
        }

        /* Header Styles */
        .header {
            background: rgba(0,0,0,0.5); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(220,38,38,0.2);
            position: sticky; top: 0; z-index: 10; padding: 1rem 0;
        }
        .header-content {
            max-width: 1200px; margin: auto; padding: 0 1.5rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-left { display: flex; align-items: center; gap: 0.75rem; }
        .header-icon {
            background: #dc2626; padding: 0.5rem; border-radius: 0.5rem;
            display: flex; align-items: center; justify-content: center;
        }
        .header-title h1 { font-size: 1.5rem; font-weight: bold; }
        .header-title p { color: #9ca3af; font-size: 0.875rem; }
        .header-stats { display: flex; gap: 1rem; }
        .stat-badge {
            border: 1px solid #dc2626; color: #f87171;
            padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem;
            display: flex; align-items: center; gap: 0.25rem;
        }
        .container { max-width: 1200px; margin: auto; padding: 2rem 1.5rem; }
        
        /* Tabs Styles */
        .tabs { margin-bottom: 1.5rem; }
        .tab-list {
            display: grid; grid-template-columns: repeat(4,1fr);
            background: rgba(31,41,55,0.5);
            border: 1px solid #374151; border-radius: 0.5rem; padding: 0.25rem;
        }
        .tab-button {
            background: none; border: none; color: white;
            padding: 0.75rem 1rem; border-radius: 0.25rem; cursor: pointer;
            transition: all 0.2s; font-size: 0.875rem;
        }
        .tab-button:hover { background: rgba(55,65,81,0.5); }
        .tab-button.active { background: #dc2626; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Notification Styles */
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem;
            border-radius: 0.5rem; color: white; font-weight: 500; z-index: 1000;
            transform: translateX(100%); transition: transform 0.3s ease;
        }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #059669; border: 1px solid #10b981; }
        .notification.error { background: #dc2626; border: 1px solid #ef4444; }
        
        /* Stats Grid Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        .stat-content { display: flex; justify-content: space-between; align-items: center; }
        .stat-info h3 { color: #9ca3af; font-size: 0.875rem; margin-bottom: 0.5rem; }
        .stat-info p { font-size: 2rem; font-weight: bold; }
        .stat-icon { width: 2rem; height: 2rem; color: #dc2626; }

        /* Card Styles */
        .card {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid #374151;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .card-header { padding: 1.5rem; border-bottom: 1px solid #374151; }
        .card-title {
            font-size: 1.25rem; font-weight: 600;
            display: flex; align-items: center; gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .card-description { color: #9ca3af; font-size: 0.875rem; }
        .card-content { padding: 1.5rem; }

        /* Form Styles */
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem; margin-bottom: 1.5rem;
        }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-label { color: #d1d5db; font-size: 0.875rem; font-weight: 500; }
        .form-input, .form-select {
            background: #374151; border: 1px solid #4b5563; color: white;
            padding: 0.75rem; border-radius: 0.375rem;
        }
        .form-input:focus, .form-select:focus {
            outline: none; border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 0.375rem;
            font-weight: 500; cursor: pointer; transition: all 0.2s;
            border: none; font-size: 0.875rem;
        }
        .btn-primary { background: #dc2626; color: white; }
        .btn-primary:hover { background: #b91c1c; }
        .btn-primary:disabled { background: #6b7280; cursor: not-allowed; }
        .btn-full { width: 100%; }

        /* Package List Styles */
        .package-list { max-height: 320px; overflow-y: auto; }
        .package-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem; background: rgba(55, 65, 81, 0.5);
            border-radius: 0.5rem; border: 1px solid #4b5563; margin-bottom: 0.75rem;
        }
        .package-info h4 { font-weight: 500; margin-bottom: 0.25rem; }
        .package-info p { color: #9ca3af; font-size: 0.875rem; }

        /* Record List Styles (for reports and modify) */
        .records-list { max-height: 400px; overflow-y: auto; }
        .record-item {
            background: rgba(55, 65, 81, 0.5); border: 1px solid #4b5563;
            border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem;
        }
        .record-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;
        }
        .record-field h5 { color: #9ca3af; font-size: 0.875rem; margin-bottom: 0.25rem; }
        .record-field p { font-weight: 500; }

        /* Loading Indicator Styles */
        .loading { text-align: center; padding: 2rem; color: #9ca3af; }

        /* Reports Sub-Tabs Styles */
        .report-sub-tabs {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .report-sub-tab-list {
            display: flex;
            background: rgba(31,41,55,0.5);
            border: 1px solid #374151; border-radius: 0.5rem; padding: 0.25rem;
        }
        .report-sub-tab-button {
            background: none; border: none; color: white;
            padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer;
            transition: all 0.2s; font-size: 0.875rem;
            flex-grow: 1;
        }
        .report-sub-tab-button:hover { background: rgba(55,65,81,0.5); }
        .report-sub-tab-button.active { background: #dc2626; color: white; }
        .report-sub-tab-content { display: none; padding-top: 1.5rem; }
        .report-sub-tab-content.active { display: block; }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 1rem; }
            .header-stats { flex-wrap: wrap; justify-content: center; }
            .tab-list { grid-template-columns: repeat(2, 1fr); gap: 0.25rem; }
            .form-grid { grid-template-columns: 1fr; }
            .record-grid { grid-template-columns: 1fr; }
            .report-sub-tab-list { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="login-page">
        <div class="login-card">
            <h2>Admin Login</h2>
            <div class="form-group">
                <label for="adminName" class="form-label">Admin Name</label>
                <input type="text" id="adminName" class="form-input" placeholder="Enter admin name">
            </div>
            <div class="form-group">
                <label for="adminPassword" class="form-label">Password</label>
                <input type="password" id="adminPassword" class="form-input" placeholder="Enter password">
            </div>
            <button id="loginBtn" class="btn btn-primary">Login</button>
            <p id="loginMessage" class="login-message"></p>
        </div>
    </div>

    <div id="dashboard-content">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 7h-9"></path>
                            <path d="M14 17H5"></path>
                            <path d="M17 11H5"></path>
                        </svg>
                    </div>
                    <div class="header-title">
                        <h1>Course Management</h1>
                        <p>Admin Dashboard</p>
                    </div>
                </div>
                <div class="header-stats">
                    <div class="stat-badge">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M22 21v-2a4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 0 0 1 0 7.75"></path>
                        </svg>
                        <span id="totalStudents">0</span> Students
                    </div>
                    <div class="stat-badge">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 7h-9"></path>
                            <path d="M14 17H5"></path>
                            <path d="M17 11H5"></path>
                        </svg>
                        <span id="totalPackages">0</span> Packages
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-info">
                            <h3>Total Students</h3>
                            <p id="statTotalStudents">0</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-info">
                            <h3>Total Packages</h3>
                            <p id="statTotalPackages">0</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-info">
                            <h3>Total Assignments</h3>
                            <p id="statTotalAssignments">0</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-info">
                            <h3>Batch Distribution</h3>
                            <div id="batchDistribution"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <div class="tab-list">
                    <button class="tab-button active" data-tab="packages">Package Management</button>
                    <button class="tab-button" data-tab="assign">Student Assignment</button>
                    <button class="tab-button" data-tab="modify">Data Modification</button>
                    <button class="tab-button" data-tab="reports">Reports</button>
                </div>
            </div>

            <div id="packages" class="tab-content active">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Add New Package</h2>
                            <p class="card-description">Create a new course package</p>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label class="form-label">Package ID</label>
                                <input type="text" id="packageId" class="form-input" placeholder="e.g., PKG001">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Package Name</label>
                                <input type="text" id="packageName" class="form-input" placeholder="e.g., Premium Math Course">
                            </div>
                            <button id="addPackageBtn" class="btn btn-primary btn-full">Add Package</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Available Packages</h2>
                            <p class="card-description"><span id="packageCount">0</span> packages available</p>
                        </div>
                        <div class="card-content">
                            <div id="packageList" class="package-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="assign" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Assign Package to Student</h2>
                        <p class="card-description">Assign a course package to a student</p>
                    </div>
                    <div class="card-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Registration ID</label>
                                <input type="text" id="studentRegId" class="form-input" placeholder="e.g., STU001">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Package</label>
                                <select id="studentPackage" class="form-select">
                                    <option value="">Select package</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Duration</label>
                                <select id="studentDuration" class="form-select">
                                    <option value="">Select duration</option>
                                    <option value="3 months">3 months</option>
                                    <option value="6 months">6 months</option>
                                    <option value="9 months">9 months</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Batch</label>
                                <select id="studentBatch" class="form-select">
                                    <option value="">Select batch</option>
                                    <option value="2025 Batch">2025 Batch</option>
                                    <option value="2026 Batch">2026 Batch</option>
                                    <option value="2027 Batch">2027 Batch</option>
                                </select>
                            </div>
                        </div>
                        <button id="assignPackageBtn" class="btn btn-primary">Assign Package</button>
                    </div>
                </div>
            </div>

            <div id="modify" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Modify Student Data</h2>
                        <p class="card-description">Search and modify student package assignments</p>
                    </div>
                    <div class="card-content">
                        <div class="form-grid" style="grid-template-columns: 1fr auto;">
                            <div class="form-group">
                                <label class="form-label">Search by Registration ID</label>
                                <input type="text" id="modifySearchId" class="form-input" placeholder="Enter Registration ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <button id="searchModifyBtn" class="btn btn-primary">Search</button>
                            </div>
                        </div>
                        <div id="modifyResults"></div>
                    </div>
                </div>
            </div>

            <div id="reports" class="tab-content">
                <div class="report-sub-tabs">
                    <div class="report-sub-tab-list">
                        <button class="report-sub-tab-button active" data-sub-tab="studentReportSub">Student Report</button>
                        <button class="report-sub-tab-button" data-sub-tab="dateReportSub">Date Report</button>
                        <button class="report-sub-tab-button" data-sub-tab="packageReportSub">Package Report</button>
                        <button class="report-sub-tab-button" data-sub-tab="packageCountReportSub">Package Count</button>
                    </div>
                </div>

                <div id="studentReportSub" class="report-sub-tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Student Report</h2>
                            <p class="card-description">View comprehensive student package assignments</p>
                        </div>
                        <div class="card-content">
                            <div class="form-grid" style="grid-template-columns: 1fr auto;">
                                <div class="form-group">
                                    <label class="form-label">Search by Registration ID</label>
                                    <input type="text" id="reportSearchId" class="form-input" placeholder="Enter Registration ID">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button id="generateReportBtn" class="btn btn-primary">Generate Report</button>
                                </div>
                            </div>
                            <div id="reportResults"></div>
                        </div>
                    </div>
                </div>

                <div id="dateReportSub" class="report-sub-tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Date Report</h2>
                            <p class="card-description">View all records for a specific date</p>
                        </div>
                        <div class="card-content">
                            <div class="form-grid" style="grid-template-columns: 1fr auto;">
                                <div class="form-group">
                                    <label class="form-label">Select Date</label>
                                    <input type="date" id="dateReportInput" class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button id="generateDateReportBtn" class="btn btn-primary">Generate</button>
                                </div>
                            </div>
                            <div id="dateReportResults"></div>
                        </div>
                    </div>
                </div>

                <div id="packageReportSub" class="report-sub-tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Package Report</h2>
                            <p class="card-description">View all students assigned to a specific package</p>
                        </div>
                        <div class="card-content">
                            <div class="form-grid" style="grid-template-columns: 1fr auto;">
                                <div class="form-group">
                                    <label class="form-label">Select Package</label>
                                    <select id="packageReportSelect" class="form-select">
                                        <option value="">Select a package</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button id="generatePackageReportBtn" class="btn btn-primary">Generate Report</button>
                                </div>
                            </div>
                            <div id="packageReportResults"></div>
                        </div>
                    </div>
                </div>

                <div id="packageCountReportSub" class="report-sub-tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Package Count</h2>
                            <p class="card-description">View packages and their counts for a specific date range</p>
                        </div>
                        <div class="card-content">
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr auto;">
                                <div class="form-group">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" id="packageCountStartDateInput" class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">End Date</label>
                                    <input type="date" id="packageCountEndDateInput" class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button id="generatePackageCountBtn" class="btn btn-primary">Generate</button>
                                </div>
                            </div>
                            <div id="packageCountResults"></div>
                        </div>
                    </div>
                </div>
                </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // !! IMPORTANT: Replace with your deployed Apps Script Web App URL !!
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzQgiOhAH2uFfpZyhnX5syKBKlmr2QOOHqWOdK7UunrWyp2_tvCt0ym4l1pdmI5sEqV/exec';

        let packages = [];
        let studentRecords = [];
        let loading = false;

        // Admin Login Credentials
        const ADMIN_NAME = "PCA Admin";
        const ADMIN_PASSWORD = "PCA@1369";

        // --- Utility Functions ---
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function setLoading(isLoading) {
            loading = isLoading;
            // Disable all buttons on the dashboard content, but not the login button
            document.querySelectorAll('#dashboard-content .btn').forEach(btn => btn.disabled = isLoading);
            // Ensure the login button is handled separately
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) { // Check if loginBtn exists before trying to access disabled
                loginBtn.disabled = isLoading;
            }
        }

        async function callBackend(data) {
            try {
                setLoading(true);
                const res = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return await res.json();
            } catch (err) {
                console.error('Backend error:', err);
                showNotification('Connection to backend failed.', 'error');
                throw err;
            } finally {
                setLoading(false);
            }
        }

        // --- Data Loading and UI Updates ---
        async function loadAllData() {
            const result = await callBackend({ action: 'getData' });
            if (result && result.success) {
                packages = result.data.packages.map(row => ({ id: row[0], name: row[1] }));
                studentRecords = result.data.students;
                updatePackageList();
                updatePackageSelect();
                updatePackageSelectForReport();
                updateStats();
            } else if (result && result.message) {
                showNotification(result.message, 'error');
            }
        }

        function updatePackageList() {
            const packageList = document.getElementById('packageList');
            const packageCount = document.getElementById('packageCount');
            packageCount.textContent = packages.length;
            packageList.innerHTML = '';
            if (packages.length === 0) {
                packageList.innerHTML = '<p style="text-align:center; color:#9ca3af; padding:2rem;">No packages available</p>';
                return;
            }
            packages.forEach(pkg => {
                const div = document.createElement('div');
                div.className = 'package-item';
                div.innerHTML = `
                    <div class="package-info">
                        <h4>${pkg.name}</h4>
                        <p>ID: ${pkg.id}</p>
                    </div>
                    <div class="stat-badge">Active</div>`;
                packageList.appendChild(div);
            });
        }

        function updatePackageSelect() {
            const select = document.getElementById('studentPackage');
            select.innerHTML = '<option value="">Select package</option>';
            packages.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg.name;
                option.textContent = pkg.name;
                select.appendChild(option);
            });
        }

        function updatePackageSelectForReport() {
            const select = document.getElementById('packageReportSelect');
            select.innerHTML = '<option value="">Select a package</option>';
            packages.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg.name;
                option.textContent = pkg.name;
                select.appendChild(option);
            });
        }

        function updateStats() {
            const totalStudents = new Set(studentRecords.map(r => r.registrationId)).size;
            const totalPackages = packages.length;
            const totalAssignments = studentRecords.length;
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalPackages').textContent = totalPackages;
            document.getElementById('statTotalStudents').textContent = totalStudents;
            document.getElementById('statTotalPackages').textContent = totalPackages;
            document.getElementById('statTotalAssignments').textContent = totalAssignments;

            const batchCounts = {};
            ['2025 Batch', '2026 Batch', '2027 Batch'].forEach(batch => {
                batchCounts[batch] = studentRecords.filter(r => r.batch === batch).length;
            });
            const batchDistribution = document.getElementById('batchDistribution');
            batchDistribution.innerHTML = '';
            Object.entries(batchCounts).forEach(([batch, count]) => {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.fontSize = '0.875rem';
                div.style.marginBottom = '0.25rem';
                div.innerHTML = `<span style="color:#d1d5db;">${batch}:</span><span style="font-weight:500;">${count}</span>`;
                batchDistribution.appendChild(div);
            });
        }

        function getPackageIdByName(packageName) {
            const pkg = packages.find(p => p.name === packageName);
            return pkg ? pkg.id : '';
        }

        // --- CRUD Operations ---
        async function addPackage(packageData) {
            if (!packageData.id || !packageData.name) {
                showNotification('Please fill in both Package ID and Package Name.', 'error');
                return false;
            }
            const result = await callBackend({ action: 'addPackage', packageData });
            if (result && result.success) {
                showNotification(result.message);
                return true;
            } else {
                showNotification(result.message, 'error');
                return false;
            }
        }

        async function assignStudentPackage(studentData) {
            if (!studentData.registrationId || !studentData.packageName || !studentData.duration || !studentData.batch) {
                showNotification('Please fill in all fields.', 'error');
                return false;
            }
            const result = await callBackend({ action: 'assignPackage', studentData });
            if (result && result.success) {
                showNotification(result.message);
                return true;
            } else {
                showNotification(result.message, 'error');
                return false;
            }
        }

        async function saveStudentUpdate(original, parent) {
            const updated = {
                batch: parent.querySelector('[data-field="batch"]').value,
                rowIndex: original.rowIndex,
                registrationId: parent.querySelector('[data-field="registrationId"]').value,
                packageName: parent.querySelector('[data-field="packageName"]').value,
                duration: parent.querySelector('[data-field="duration"]').value,
                date: parent.querySelector('[data-field="date"]').value
            };

            if (!updated.registrationId || !updated.packageName || !updated.duration || !updated.batch || !updated.date) {
                showNotification('All fields must be filled to update.', 'error');
                return;
            }

            const result = await callBackend({ action: 'updateStudent', updatedData: updated });
            if (result.success) {
                showNotification(result.message);
                await loadAllData();
            } else {
                showNotification(result.message, 'error');
            }
        }

        async function deleteStudentRow(registrationId, container) {
            if (!confirm("Are you sure you want to delete this record?")) return;
            const result = await callBackend({ action: 'deleteStudent', registrationId });
            if (result.success) {
                showNotification(result.message);
                container.remove();
                await loadAllData();
            } else {
                showNotification(result.message, 'error');
            }
        }

        // --- Report Rendering Functions ---
        function renderModifyResults(data) {
            const container = document.getElementById('modifyResults');
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<p style="color:#9ca3af;">No records found.</p>';
                return;
            }
            data.forEach(record => {
                let packageOptions = packages.map(pkg =>
                    `<option value="${pkg.name}"${pkg.name === record.packageName ? ' selected' : ''}>${pkg.name}</option>`
                ).join('');
                packageOptions = `<option value="">Select package</option>` + packageOptions;

                const durations = ['3 months', '6 months', '9 months'];
                let durationOptions = durations.map(d =>
                    `<option value="${d}"${d === record.duration ? ' selected' : ''}>${d}</option>`
                ).join('');
                durationOptions = `<option value="">Select duration</option>` + durationOptions;

                const batches = ['2025 Batch', '2026 Batch', '2027 Batch'];
                let batchOptions = batches.map(b =>
                    `<option value="${b}"${b === record.batch ? ' selected' : ''}>${b}</option>`
                ).join('');
                batchOptions = `<option value="">Select batch</option>` + batchOptions;

                const div = document.createElement('div');
                div.className = 'record-item';
                div.innerHTML = `
                    <div class="record-grid">
                        <div class="record-field">
                            <h5>Registration ID</h5>
                            <input value="${record.registrationId}" data-field="registrationId" class="form-input" readonly>
                        </div>
                        <div class="record-field">
                            <h5>Package Name</h5>
                            <select data-field="packageName" class="form-select">
                                ${packageOptions}
                            </select>
                        </div>
                        <div class="record-field">
                            <h5>Duration</h5>
                            <select data-field="duration" class="form-select">
                                ${durationOptions}
                            </select>
                        </div>
                        <div class="record-field">
                            <h5>Batch</h5>
                            <select data-field="batch" class="form-select">
                                ${batchOptions}
                            </select>
                        </div>
                        <div class="record-field">
                            <h5>Date</h5>
                            <input type="date" value="${record.date}" data-field="date" class="form-input">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick='saveStudentUpdate(${JSON.stringify(record).replace(/"/g, "&quot;")}, this.parentElement)'>Save</button>
                    <button class="btn btn-danger" onclick='deleteStudentRow("${record.registrationId}", this.parentElement)'>Delete</button>
                `;
                container.appendChild(div);
            });
        }

        function renderReportResults(data) {
            const container = document.getElementById('reportResults');
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<p style="color:#9ca3af;">No records found.</p>';
                return;
            }
            data.forEach(record => {
                const div = document.createElement('div');
                div.className = 'record-item';
                div.innerHTML = `
                    <div class="record-grid">
                        <div class="record-field"><h5>Batch</h5><p>${record.batch}</p></div>
                        <div class="record-field"><h5>Reg ID</h5><p>${record.registrationId}</p></div>
                        <div class="record-field"><h5>Package</h5><p>${getPackageIdByName(record.packageName)}</p></div>
                        <div class="record-field"><h5>Duration</h5><p>${record.duration}</p></div>
                        <div class="record-field"><h5>Date</h5><p>${record.date}</p></div>
                    </div>`;
                container.appendChild(div);
            });
        }

        function renderDateReportResults(data) {
            const container = document.getElementById('dateReportResults');
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<p style="color:#9ca3af;">No records found for this date.</p>';
                return;
            }
            data.forEach(record => {
                const div = document.createElement('div');
                div.className = 'record-item';
                div.innerHTML = `
                    <div class="record-grid">
                        <div class="record-field"><h5>Batch</h5><p>${record.batch}</p></div>
                        <div class="record-field"><h5>Reg ID</h5><p>${record.registrationId}</p></div>
                        <div class="record-field"><h5>Package</h5><p>${getPackageIdByName(record.packageName)}</p></div>
                        <div class="record-field"><h5>Duration</h5><p>${record.duration}</p></div>
                        <div class="record-field"><h5>Date</h5><p>${record.date}</p></div>
                    </div>`;
                container.appendChild(div);
            });
        }

        function renderPackageReportResults(data) {
            const container = document.getElementById('packageReportResults');
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<p style="color:#9ca3af;">No students found for this package.</p>';
                return;
            }
            data.forEach(record => {
                const div = document.createElement('div');
                div.className = 'record-item';
                div.innerHTML = `
                    <div class="record-grid">
                        <div class="record-field"><h5>Batch</h5><p>${record.batch}</p></div>
                        <div class="record-field"><h5>Reg ID</h5><p>${record.registrationId}</p></div>
                        <div class="record-field"><h5>Package</h5><p>${getPackageIdByName(record.packageName)}</p></div>
                        <div class="record-field"><h5>Duration</h5><p>${record.duration}</p></div>
                        <div class="record-field"><h5>Date</h5><p>${record.date}</p></div>
                    </div>`;
                container.appendChild(div);
            });
        }

        // MODIFIED: Package Count Report Logic
        function generatePackageCountReport(startDate, endDate) {
            const packagesTaken = {};
            let totalPackagesForPeriod = 0;

            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;

            studentRecords.forEach(record => {
                const recordDate = new Date(record.date); // Assuming record.date is YYYY-MM-DD

                let isInRange = true;
                if (start && recordDate < start) {
                    isInRange = false;
                }
                if (end && recordDate > end) {
                    isInRange = false;
                }

                if (isInRange) {
                    const packageName = record.packageName;
                    packagesTaken[packageName] = (packagesTaken[packageName] || 0) + 1;
                    totalPackagesForPeriod++;
                }
            });
            renderPackageCountResults(packagesTaken, totalPackagesForPeriod);
        }

        function renderPackageCountResults(packageCounts, totalCount) {
            const container = document.getElementById('packageCountResults');
            container.innerHTML = ''; // Clear previous results

            if (totalCount === 0) {
                container.innerHTML = '<p style="color:#9ca3af;">No packages found for the selected period.</p>';
                return;
            }

            let htmlContent = '<div class="records-list">'; // Use records-list for consistent styling
            for (const pkgName in packageCounts) {
                htmlContent += `
                    <div class="record-item">
                        <div class="record-grid" style="grid-template-columns: 2fr 1fr;">
                            <div class="record-field"><h5>Package Name</h5><p>${pkgName}</p></div>
                            <div class="record-field"><h5>Count</h5><p>${packageCounts[pkgName]}</p></div>
                        </div>
                    </div>
                `;
            }
            htmlContent += '</div>'; // Close records-list

            htmlContent += `
                <div style="margin-top: 1.5rem; text-align: right; font-size: 1.2rem; font-weight: bold; color: #f87171; padding-right: 1rem;">
                    Total Packages Taken: ${totalCount}
                </div>
            `;
            container.innerHTML = htmlContent;
        }


        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get references to login and dashboard elements
            const loginPage = document.getElementById('login-page');
            const dashboardContent = document.getElementById('dashboard-content');
            const adminNameInput = document.getElementById('adminName');
            const adminPasswordInput = document.getElementById('adminPassword');
            const loginBtn = document.getElementById('loginBtn');
            const loginMessage = document.getElementById('loginMessage');

            // Set initial display state
            loginPage.style.display = 'flex'; // Show login
            dashboardContent.style.display = 'none'; // Hide dashboard

            // Login Button Listener
            loginBtn.addEventListener('click', () => {
                const enteredAdminName = adminNameInput.value.trim();
                const enteredPassword = adminPasswordInput.value.trim();

                if (enteredAdminName === ADMIN_NAME && enteredPassword === ADMIN_PASSWORD) {
                    loginPage.style.display = 'none'; // Hide login page
                    dashboardContent.style.display = 'block'; // Show dashboard content
                    loadAllData(); // Load dashboard data after successful login
                    showNotification('Welcome, Admin!', 'success');
                } else {
                    loginMessage.textContent = "You are not an admin! Go on, shoo!"; // Funny comment
                    loginMessage.style.color = '#ef4444'; // Red color for error
                }
            });

            // Allow pressing Enter in password field to log in
            adminPasswordInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    loginBtn.click(); // Simulate click on login button
                }
            });

            // Main tabs functionality
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function () {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(this.dataset.tab).classList.add('active');

                    // If the "Reports" tab is activated, ensure the first sub-tab is also active
                    if (this.dataset.tab === 'reports') {
                        const firstSubTabButton = document.querySelector('#reports .report-sub-tab-button');
                        const firstSubTabContent = document.querySelector('#reports .report-sub-tab-content');
                        if (firstSubTabButton && firstSubTabContent) {
                            // Deactivate all sub-tab buttons and content first
                            document.querySelectorAll('#reports .report-sub-tab-button').forEach(btn => btn.classList.remove('active'));
                            document.querySelectorAll('#reports .report-sub-tab-content').forEach(content => content.classList.remove('active'));
                            // Activate the first sub-tab
                            firstSubTabButton.classList.add('active');
                            firstSubTabContent.classList.add('active');
                        }
                    }
                });
            });

            // Sub-tabs functionality for Reports
            document.querySelectorAll('.report-sub-tab-button').forEach(button => {
                button.addEventListener('click', function () {
                    const parentTabContent = this.closest('.tab-content');
                    parentTabContent.querySelectorAll('.report-sub-tab-button').forEach(btn => btn.classList.remove('active'));
                    parentTabContent.querySelectorAll('.report-sub-tab-content').forEach(content => content.classList.remove('active'));

                    this.classList.add('active');
                    document.getElementById(this.dataset.subTab).classList.add('active');
                });
            });

            // Add Package Event Listener
            document.getElementById('addPackageBtn').addEventListener('click', async () => {
                const id = document.getElementById('packageId').value;
                const name = document.getElementById('packageName').value;
                if (await addPackage({ id, name })) {
                    document.getElementById('packageId').value = '';
                    document.getElementById('packageName').value = '';
                    await loadAllData();
                }
            });

            // Assign Package Event Listener
            document.getElementById('assignPackageBtn').addEventListener('click', async () => {
                const studentData = {
                    registrationId: document.getElementById('studentRegId').value,
                    packageName: document.getElementById('studentPackage').value,
                    duration: document.getElementById('studentDuration').value,
                    batch: document.getElementById('studentBatch').value
                };
                if (await assignStudentPackage(studentData)) {
                    document.getElementById('studentRegId').value = '';
                    document.getElementById('studentPackage').value = '';
                    document.getElementById('studentDuration').value = '';
                    document.getElementById('studentBatch').value = '';
                    await loadAllData();
                }
            });

            // Search Modify Event Listener
            document.getElementById('searchModifyBtn').addEventListener('click', async () => {
                const regId = document.getElementById('modifySearchId').value;
                if (!regId) {
                    showNotification('Enter Registration ID', 'error');
                    return;
                }
                const result = await callBackend({ action: 'searchStudent', registrationId: regId });
                if (result.success) {
                    renderModifyResults(result.data);
                } else {
                    showNotification(result.message, 'error');
                }
            });

            // Generate Student Report Event Listener
            document.getElementById('generateReportBtn').addEventListener('click', async () => {
                const regId = document.getElementById('reportSearchId').value;
                const result = await callBackend({ action: 'searchStudent', registrationId: regId });
                if (result.success) {
                    renderReportResults(result.data);
                } else {
                    showNotification(result.message, 'error');
                }
            });

            // Generate Date Report Event Listener
            document.getElementById('generateDateReportBtn').addEventListener('click', async () => {
                const date = document.getElementById('dateReportInput').value;
                if (!date) {
                    showNotification('Please select a date.', 'error');
                    return;
                }
                const result = await callBackend({ action: 'searchByDate', date: date });
                if (result.success) {
                    renderDateReportResults(result.data);
                } else {
                    showNotification(result.message, 'error');
                }
            });

            // Generate Package Report Event Listener
            document.getElementById('generatePackageReportBtn').addEventListener('click', async () => {
                const selectedPackageName = document.getElementById('packageReportSelect').value;
                if (!selectedPackageName) {
                    showNotification('Please select a package.', 'error');
                    return;
                }
                const filteredRecords = studentRecords.filter(record => record.packageName === selectedPackageName);
                renderPackageReportResults(filteredRecords);
            });

            // MODIFIED: Generate Package Count Report Event Listener
            document.getElementById('generatePackageCountBtn').addEventListener('click', () => {
                const startDate = document.getElementById('packageCountStartDateInput').value;
                const endDate = document.getElementById('packageCountEndDateInput').value;

                if (!startDate && !endDate) {
                    showNotification('Please select at least a Start Date or End Date for Package Count.', 'error');
                    return;
                }
                
                generatePackageCountReport(startDate, endDate);
            });
        });
    </script>
</body>
</html>